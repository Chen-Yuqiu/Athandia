 <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <link type="text/css" rel="stylesheet" href="./style/jsmind.css" />
        <script type="text/javascript" src="./js/jsmind.js"></script>
        <script type="text/javascript" src="./js/jsmind.draggable.js"></script>
        <script type="text/javascript" src="./js/jsmind.screenshot.js"></script>
        <script src="https://cdn.wilddog.com/js/client/current/wilddog.js"></script>
        <script src="https://cdn.wilddog.com/sdk/js/2.5.8/wilddog.js"></script>
        
        <style type="text/css">
        li{margin-top:2px; margin-bottom:2px;}
        button{width:140px;}
        select{width:140px;}
        #layout{width:1230px;}
        #jsmind_nav{width:210px;height:500px;border:solid 1px #ccc;overflow:auto;float:left;}
        .file_input{width:100px;}
        button.sub{width:100px;}

        #jsmind_container{
            float:left;
            width:800px;
            height:500px;
            border:solid 1px #ccc;
            background:#f4f4f4;
        }
        #jsmind_comment{
            
        }
    </style>
        <!--
        <script type="text/javascript" src="js/jsmind.draggable.js"></script>
        -->
    </head>
    <body>
    <div id="layout">
    <div id="jsmind_nav">
        <div>1. Open</div>
        <ol type='A'>
            <li><button class="functionbutton" onclick="open_json();">open example</button></li>
            <li><button class="functionbutton" onclick="open_instructions();">open instructions</button></li>
            <li><button class="functionbutton" onclick="screen_shot();">screenshot</button></li>
        </ol>
       
        <div>2. Edit</div>
        <ol type='A'>
            <li><button class="functionbutton" onclick="toggle_editable(this);">disable editable</button></li>
            <li><button class="functionbutton" onclick="javascript:window.open('details.html')">add detail</button></li>
            <li><button class="functionbutton" onclick="javascript:window.open('timeline1.0.html')">set timeline</button></li>
            <li><button class="functionbutton" onclick="add_node();">add a node</button></li>
            <li><button class="functionbutton" onclick="add_image_node();">add a image node</button></li>
            <li><button class="functionbutton" onclick="saveimage()";>save your image</button></li>
        </ol>

        <div>3. Save</div>
        <ol type='A'>
            <li>Save your project here</li>
            <ol>
                <li><button class="sub" onclick="show_data();">show data</button></li>
                <li><button class="sub" onclick="save_towilddog();">save as your project</button></li>
                <li><button class="sub" onclick="open_fromwilddog();">load from your project</button></li>
                <li><input id="file_input" class="file_input" type="file"/></li>
                <li><button class="sub" onclick="save_file();">save to the local</button></li>
                <li><button class="sub" onclick="open_file();">open from the local</button></li>
            </ol>
        </ol>
    </div>
    <div id="jsmind_container"></div>
    <div style="display:none">
      <input class="file" type="file" id="image-chooser" accept="image/*"/>
    </div>

    <div id="jsmind_comment">
        
    </div>
</div>

<script type="text/javascript">
    //获取uid来对应用户的jsmind
    /*var url = location.search;
    var uid = url.slice(5,33);
    //alert(uid);
    //获取对应打开的项目
    var title = url.slice(45).replace("%20"," ");
    console.log(title);
    var editable = url.slice(34,38);
    console.log(editable);*/
    var editable = true;
    //以下是主要功能部分
    var config = {
            syncURL: "https://wd0030641220gbvazm.wilddogio.com|" //输入节点 URL
        };
    wilddog.initializeApp(config);
    var ref = wilddog.sync().ref('test');
    //var list = wilddog.sync().ref('allpro');
    var _jm = null;
    function open_empty(){
        var options = {
            container:'jsmind_container',
            theme:'orange',
            editable:true
        }
        _jm = jsMind.show(options);
        // _jm = jsMind.show(options,mind);
    }



    function open_json(){
        var mind = {
            "meta":{"name":"project","author":"1211274095@qq.com","version":"0.4a"},"format":"node_tree","data":{"id":"root","topic":"生物医药","expanded":true,"children":[{"id":"d7374290c2e481e9","topic":"生物实验常用方法阅读","expanded":true,"direction":"right"},{"id":"d73742a888f01091","topic":"各种癌症药物研究试验的paper","expanded":true,"direction":"right","children":[{"id":"d73754f10c7144df","topic":"思路一（先尝试后放弃）根据原先阅读的文献中提到的展望、未解决之问题入手：研究中要对抗血管治疗癌症的作用","expanded":true}]},{"id":"d73742be833aee99","topic":"纳米技术","expanded":true,"direction":"left"},{"id":"d73742d6717b848a","topic":"组织工程技术目前研究发展","expanded":true,"direction":"left","children":[{"id":"d73756f43f68f1df","topic":"关于思路二：浏览新闻周刊？发现pm2.5对皮肤伤害的报道","expanded":true,"children":[{"id":"d73761c46ff547fa","topic":"文献检索：发现该问题的研究时间非常短，且研究局限于模糊的定性研究：例如收集某城市居民的反馈等","expanded":true,"children":[{"id":"deee6b291cd5d77c","topic":"提出问题：pm2.5如何伤害人体皮肤？可能的修复机理是怎样的？","expanded":true,"children":[{"id":"deeea5c9ff32f81e","topic":"？（实验设计）","expanded":true,"children":[{"id":"deeeab14e74d8852","topic":"实验不足","expanded":true,"children":[{"id":"deeebeebcbcf1ca1","topic":"只用了一种细胞","expanded":true},{"id":"deeebef5d92480c0","topic":"只用了一种药物","expanded":true},{"id":"deeebefe5fbc0c64","topic":"停留在细胞模型","expanded":true,"children":[{"id":"deeed60c77d93c7f","topic":"进行进一步的实体皮肤实验：例如裸鼠皮肤","expanded":true}]}]},{"id":"deeeab2ce52e2867","topic":"过程中的意外发现：纳米技术采用前后结果的区别","expanded":true,"children":[{"id":"deeebfb5d3cf2964","topic":"可能原因分析","expanded":true},{"id":"deeebfc16da22a5c","topic":"中药与纳米技术的结合","expanded":true}]},{"id":"deeeab4371fd33c8","topic":"主要结论：pm2.5伤害机制、修复的信号通路","expanded":true}]},{"id":"deeea6087ca6eaab","topic":"？（理论推测）","expanded":true}]}]}]}]}]}}
        _jm.show(mind);
    }

    function open_instructions(){
        var mind = {"meta":{"name":"project","author":"1211274095@qq.com","version":"0.4a"},"format":"node_tree","data":{"id":"root","topic":"double click nodes to start","expanded":true,"children":[{"id":"d7374290c2e481e9","topic":"question 2","expanded":true,"direction":"right","children":[{"id":"d7375032eb9a3cad","topic":"assumption 1","expanded":true,"children":[{"id":"d7375a25f33c017f","topic":"experiment 1","expanded":true}]}]},{"id":"d73742a888f01091","topic":"question 3","expanded":true,"direction":"right","children":[{"id":"d73754f10c7144df","topic":"assumption 2","expanded":true,"children":[{"id":"d7375ef7437a0f51","topic":"experiment 1","expanded":true}]}]},{"id":"d73742be833aee99","topic":"conclusion 1","expanded":true,"direction":"left"},{"id":"d73742d6717b848a","topic":"question 1 ","expanded":true,"direction":"left","children":[{"id":"d73756f43f68f1df","topic":"assumption 1","expanded":true,"children":[{"id":"d73761c46ff547fa","topic":"experiment 1","expanded":true}]}]},{"id":"d73742e3e2a433d3","topic":"conclusion 2","expanded":true,"direction":"right"}]}}
        _jm.show(mind);       
    }

    function screen_shot(){
        if(editable){
            _jm.screenshot.shootDownload();
        };
    }

    function save_file(){
        if(editable){
            var mind_data = _jm.get_data();
            var mind_name = mind_data.meta.name;
            var mind_str = jsMind.util.json.json2string(mind_data);
        jsMind.util.file.save(mind_str,'text/jsmind',mind_name+'.jm');
        }
    }

    function save_towilddog(){  
        if(editable){
            //保存到自己的project
            var mind_data = _jm.get_data();
            //var Data = jsMind.util.json.json2string(mind_data);
            ref.child("jsmind").set(mind_data, function (error) {
                if (error == null) {
                    console.info("Saved to Wilddog");
                    console.log(mind_data);;
                }
                else {
                    alert(error);
                }
            });
            
            /*//保存到所有project
            var keytitle = title;
            //alert(key);
            list.on("child_added",function(snapshot){
            //找到指定project
                snapshot.forEach(function(data) {
                    if(data.val()==keytitle){
                        console.log(snapshot.key());
                        //将指定project返回
                        list.child(snapshot.key()).child(keytitle).set(mind_data, function (error) {
                        });

                    }
                })
            });*/

        }        

    }

    function open_fromwilddog(){
        ref.child("jsmind").on("value", function(snapshot){
        //console.log(typeof(snapshot.value()));
        //console.log(typeof(snapshot.val()));
        var mind = snapshot.val();
        console.info(mind);
        _jm.show(mind);
        _jm.disable_edit();
        });
    }

    function open_file(){
        if(editable){
            var file_input = document.getElementById('file_input');
            var files = file_input.files;
            if(files.length > 0){
                var file_data = files[0];
                jsMind.util.file.read(file_data,function(jsmind_data, jsmind_name){
                    var mind = jsMind.util.json.string2json(jsmind_data);
                    if(!!mind){
                        _jm.show(mind);
                    }else{
                        prompt_info('can not open this file as mindmap');
                    }
                });
            }else{
                prompt_info('please choose a file first')
            }   
        }
    }

    function add_node(){
        if(editable){
            var selected_node = _jm.get_selected_node(); // as parent of new node
            if(!selected_node){prompt_info('please select a node first.');return;}

            var nodeid = jsMind.util.uuid.newid();
            var topic = '* Node_'+nodeid.substr(0,5)+' *';
            var node = _jm.add_node(selected_node, nodeid, topic);
        }
    }

    var imageChooser = document.getElementById('image-chooser');

    imageChooser.addEventListener('change', function (event) {
        // Read file here.
        var reader = new FileReader();
        reader.onloadend = (function () {
            var selected_node = _jm.get_selected_node();
            var nodeid = jsMind.util.uuid.newid();
            var topic = undefined;
            var data = {
                "background-image": reader.result,
                "width": "100",
                "height": "100"};
            var node = _jm.add_node(selected_node, nodeid, topic, data);
            //var node = _jm.add_image_node(selected_node, nodeid, reader.result, 100, 100);
        //add_image_node:function(parent_node, nodeid, image, width, height, data, idx, direction, expanded){
        });

        var file = imageChooser.files[0];
        if (file) {
            reader.readAsDataURL(file);
        };

    }, false);

    function add_image_node(){
        if(editable){
            var selected_node = _jm.get_selected_node(); // as parent of new node
            if(!selected_node){
                prompt_info('please select a node first.');
            return;
            }

            imageChooser.focus();
            imageChooser.click();
        }
    }

    /**function toggle_editable(btn){
        var editable = _jm.get_editable();
        if(editable){
            _jm.disable_edit();
            btn.innerHTML = 'enable editable';
        }else{
            _jm.enable_edit();
            btn.innerHTML = 'disable editable';
        }
    }**/
    
    function opennew(string){
        if(editable){
        window.open(string);
        }
    }

    open_empty();
</script>
    </body>
</html>